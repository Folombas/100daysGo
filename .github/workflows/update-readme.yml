name: Update README Daily

on:
  schedule:
    - cron: "0 14 * * *"  # 17:00 –ø–æ –ú–æ—Å–∫–≤–µ (UTC+3)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.22"
          
      - name: Set UTF-8 encoding
        run: |
          echo "LANG=C.UTF-8" >> $GITHUB_ENV
          echo "LC_ALL=C.UTF-8" >> $GITHUB_ENV

      - name: Update README
        run: |
          echo "üîÑ –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ README..."
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          go run ./utils/readme_updater/main.go
          echo "‚úÖ README –æ–±–Ω–æ–≤–ª–µ–Ω"
          
      - name: Commit and push changes
        run: |
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
          git config --global user.name "README Bot"
          git config --global user.email "readme-bot@example.com"
          git config --global core.quotepath off
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add README.md utils/readme_updater/progress.json
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --cached --quiet; then
            echo "‚è≠Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          else
            # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç
            COMMIT_DATE=$(date +'%d.%m.%Y')
            git commit -m "Auto-update: –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ $COMMIT_DATE"
            echo "üíæ –°–æ–∑–¥–∞–Ω –∫–æ–º–º–∏—Ç: –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ $COMMIT_DATE"
            
            # –ü—Ä–æ–±—É–µ–º —Å–¥–µ–ª–∞—Ç—å push —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
            ATTEMPT=1
            MAX_ATTEMPTS=3
            SUCCESS=false
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø—É—à–∞ #$ATTEMPT..."
              if git pull --rebase origin main && git push origin main; then
                echo "‚úÖ –£—Å–ø–µ—à–Ω—ã–π –ø—É—à –ø–æ—Å–ª–µ $ATTEMPT –ø–æ–ø—ã—Ç–∫–∏"
                SUCCESS=true
                break
              else
                echo "‚ùå –û—à–∏–±–∫–∞ –ø—É—à–∞, –ø–æ–ø—ã—Ç–∫–∞ $ATTEMPT/$MAX_ATTEMPTS"
                ATTEMPT=$((ATTEMPT + 1))
                sleep 5
              fi
            done
            
            if [ "$SUCCESS" = false ]; then
              echo "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—É—à –ø–æ—Å–ª–µ $MAX_ATTEMPTS –ø–æ–ø—ã—Ç–æ–∫"
              exit 1
            fi
          fi