// day88/main.go
package main

import (
	"fmt"
	"time"
	"strings"
)

// Courier –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∫—É—Ä—å–µ—Ä–∞-–≥–æ—Ä—É—Ç–∏–Ω—É
type Courier struct {
	Name string
}

// Order –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑
type Order struct {
	ID     int
	Amount int
	Urgent bool
}

func main() {
	fmt.Println("üöö –î–µ–Ω—å 88: –°–∏–º—É–ª—è—Ü–∏—è –∫—É—Ä—å–µ—Ä—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –∫–∞–Ω–∞–ª–∞—Ö Go")
	fmt.Println(strings.Repeat("=", 60))

	// –°–∏—Ç—É–∞—Ü–∏—è 1: –ù–µ–±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª (–ø—Ä—è–º–∞—è –ø–µ—Ä–µ–¥–∞—á–∞)
	fmt.Println("\n1. –ù–µ–±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª (unbuffered):")
	unbufferedDemo()

	// –°–∏—Ç—É–∞—Ü–∏—è 2: –ë—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å –∑–∞–∫–∞–∑–æ–≤)
	fmt.Println("\n2. –ë—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª (buffered, capacity=3):")
	bufferedDemo()

	// –°–∏—Ç—É–∞—Ü–∏—è 3: Deadlock –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏
	fmt.Println("\n3. –î–µ–¥–ª–æ–∫ (deadlock) ‚Äî —á—Ç–æ –±—ã–ª–æ —É –ì–æ—à–∏:")
	deadlockDemo()

	// –°–∏—Ç—É–∞—Ü–∏—è 4: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å select
	fmt.Println("\n4. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å select –∏ default:")
	smartSolutionDemo()
}

func unbufferedDemo() {
	// –ù–µ–±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª: –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –î–û–õ–ñ–ù–´ –±—ã—Ç—å –≥–æ—Ç–æ–≤—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
	ch := make(chan Order)

	go func() {
		time.Sleep(100 * time.Millisecond) // –ö—É—Ä—å–µ—Ä –Ω–µ–º–Ω–æ–≥–æ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
		order := <-ch
		fmt.Printf("  –ö—É—Ä—å–µ—Ä –ø—Ä–∏–Ω—è–ª –∑–∞–∫–∞–∑ ‚Ññ%d –Ω–∞ %d —Ä—É–±.\n", order.ID, order.Amount)
	}()

	fmt.Println("  –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑...")
	ch <- Order{ID: 1, Amount: 1000} // –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∫–∞ –∫—É—Ä—å–µ—Ä –Ω–µ –≥–æ—Ç–æ–≤
	fmt.Println("  –ó–∞–∫–∞–∑ –ø–µ—Ä–µ–¥–∞–Ω!")
}

func bufferedDemo() {
	// –ë—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª: –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –¥–æ 3 –∑–∞–∫–∞–∑–æ–≤ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
	ch := make(chan Order, 3)

	// –ë—ã—Å—Ç—Ä–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º 3 –∑–∞–∫–∞–∑–∞
	for i := 1; i <= 3; i++ {
		ch <- Order{ID: i, Amount: 500 + i*100}
		fmt.Printf("  –ó–∞–∫–∞–∑ ‚Ññ%d –ø–æ–º–µ—â—ë–Ω –≤ –±—É—Ñ–µ—Ä\n", i)
	}

	fmt.Println("  –ë—É—Ñ–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω (3/3). –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –±—É–¥—É—Ç –∂–¥–∞—Ç—å...")

	// –ö—É—Ä—å–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–±–∏—Ä–∞—Ç—å –∑–∞–∫–∞–∑—ã
	go func() {
		for i := 0; i < 3; i++ {
			time.Sleep(200 * time.Millisecond)
			order := <-ch
			fmt.Printf("  –ö—É—Ä—å–µ—Ä –∑–∞–±—Ä–∞–ª –∑–∞–∫–∞–∑ ‚Ññ%d\n", order.ID)
		}
	}()

	// –≠—Ç–æ—Ç –∑–∞–∫–∞–∑ –±—É–¥–µ—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –Ω–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è –º–µ—Å—Ç–æ –≤ –±—É—Ñ–µ—Ä–µ
	go func() {
		ch <- Order{ID: 4, Amount: 1500}
		fmt.Println("  üéâ –ñ–∏—Ä–Ω—ã–π –∑–∞–∫–∞–∑ ‚Ññ4 –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –ø–æ–º–µ—â—ë–Ω –≤ –±—É—Ñ–µ—Ä!")
	}()

	time.Sleep(1 * time.Second)
}

func deadlockDemo() {
	ch := make(chan Order, 2) // –ú–∞–ª–µ–Ω—å–∫–∏–π –±—É—Ñ–µ—Ä

	// –°–∏–º—É–ª—è—Ü–∏—è: –º–Ω–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π, –º–∞–ª–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
	for i := 1; i <= 5; i++ {
		go func(id int) {
			ch <- Order{ID: id, Amount: 300}
			fmt.Printf("  –ó–∞–∫–∞–∑ ‚Ññ%d –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è...\n", id)
		}(i)
	}

	// –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫—É—Ä—å–µ—Ä (–º–µ–¥–ª–µ–Ω–Ω—ã–π)
	go func() {
		time.Sleep(500 * time.Millisecond)
		<-ch
		fmt.Println("  –ö—É—Ä—å–µ—Ä –∑–∞–±—Ä–∞–ª –æ–¥–∏–Ω –∑–∞–∫–∞–∑")
	}()

	time.Sleep(300 * time.Millisecond)
	fmt.Println("  ‚ö†Ô∏è  –°–∏—Å—Ç–µ–º–∞ –≤ —Å—Ç—É–ø–æ—Ä–µ: –±—É—Ñ–µ—Ä –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –∫—É—Ä—å–µ—Ä—ã –Ω–µ —É—Å–ø–µ–≤–∞—é—Ç!")
}

func smartSolutionDemo() {
	normalOrders := make(chan Order, 10)   // –ë—É—Ñ–µ—Ä –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
	urgentOrders := make(chan Order)       // –ù–µ–±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è —Å—Ä–æ—á–Ω—ã—Ö
	done := make(chan bool)

	// –ì–æ—Ä—É—Ç–∏–Ω–∞-–¥–∏—Å–ø–µ—Ç—á–µ—Ä
	go func() {
		for {
			select {
			case order := <-urgentOrders:
				// –°—Ä–æ—á–Ω—ã–µ –∑–∞–∫–∞–∑—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
				fmt.Printf("  üî• –°–†–û–ß–ù–´–ô –∑–∞–∫–∞–∑ ‚Ññ%d –Ω–∞ %d —Ä—É–±. –ø—Ä–∏–Ω—è—Ç!\n", order.ID, order.Amount)
			case order := <-normalOrders:
				// –û–±—ã—á–Ω—ã–µ –∑–∞–∫–∞–∑—ã –∏–∑ –±—É—Ñ–µ—Ä–∞
				fmt.Printf("  üì¶ –û–±—ã—á–Ω—ã–π –∑–∞–∫–∞–∑ ‚Ññ%d –Ω–∞ %d —Ä—É–±.\n", order.ID, order.Amount)
			case <-done:
				return
			}
		}
	}()

	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑—ã
	urgentOrders <- Order{ID: 99, Amount: 2000, Urgent: true}
	normalOrders <- Order{ID: 1, Amount: 500}
	normalOrders <- Order{ID: 2, Amount: 600}

	time.Sleep(100 * time.Millisecond)
	done <- true
	fmt.Println("  ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –¥–µ–¥–ª–æ–∫–æ–≤!")
}
